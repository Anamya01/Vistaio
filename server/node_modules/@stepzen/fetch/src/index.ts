// Copyright IBM Corp. 2020, 2024

import * as http from 'http'
import * as https from 'https'
import fetch0 from 'node-fetch'
import {RequestInfo, RequestInit, Response} from 'node-fetch'

// workaround for https://github.com/steprz/stepzen-cli/issues/934
const httpAgent = new http.Agent({
  keepAlive: true,
  scheduling: 'lifo',
  timeout: 5000,
})

const httpsAgent = new https.Agent({
  keepAlive: true,
  scheduling: 'lifo',
  timeout: 5000,
})

const fetch = async (
  url: RequestInfo,
  init?: RequestInit,
): Promise<Response> => {
  let urlstr
  if (typeof url === 'string') {
    urlstr = url
  } else if ('href' in url) {
    urlstr = url.href
  } else {
    urlstr = url.url
  }

  return fetch0(url, {
    agent: urlstr.startsWith('https:') ? httpsAgent : httpAgent,
    ...init,
  })
}

export default fetch
