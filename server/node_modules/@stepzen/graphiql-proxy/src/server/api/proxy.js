// Copyright IBM Corp. 2020, 2024

const debug = require('debug')
const fetch = require('@stepzen/fetch').default

const {version} = require('../../../package.json')

const proxy = async (req, res) => {
  const {adminkey, debugging, zenservUrl, predicates, workspace} = req.stepzen

  let endpoint = workspace.endpoint

  let headers = {}
  if (predicates.available && predicates.enabled) {
    try {
      headers = JSON.parse(JSON.stringify(predicates.headers))
    } catch {}
  } else {
    headers = {
      Authorization: `Apikey ${adminkey}`,
    }
  }

  if (debugging.enabled) {
    headers = {
      'StepZen-Debug-Level': 1,
      ...headers,
    }
  }

  const url = `${zenservUrl}/${endpoint}/__graphql`

  debug('stepzen:dashboard')(`proxy headers: ${JSON.stringify(headers)}`)
  debug('stepzen:dashboard')(`proxy url: ${url}`)

  const response = await fetch(url, {
    body: JSON.stringify(req.body),
    headers: {
      ...headers,
      'Content-Type': 'application/json',
      'stepzen-cli-version': version,
      'user-agent': `stepzen-cli/${version}`,
    },
    method: 'POST',
  })
  const json = await response.json()

  res.json(json)
}

module.exports = proxy
